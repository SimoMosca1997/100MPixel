<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pixel Art Dapp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #info button {
      margin-top: 10px;
      padding: 5px 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #info button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="info">
    <p>Selected Pixels: <span id="selectedPixels">0</span></p>
    <button id="connectWallet">Connect Wallet</button>
    <button id="purchasePixels" disabled>Purchase Pixels</button>
  </div>

  <script>
    const CONTRACT_ADDRESS = "0x2fBeb93ca9D0f9381FE17130b1dbA00EE1e53078";
    const CONTRACT_ABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"x","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"y","type":"uint256"},{"indexed":false,"internalType":"string","name":"newImage","type":"string"}],"name":"PixelImageUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"x","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"y","type":"uint256"},{"indexed":false,"internalType":"string","name":"newLink","type":"string"}],"name":"PixelLinkUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"uint256","name":"x","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"y","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"}],"name":"PixelListedForSale","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"x","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"y","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"}],"name":"PixelPurchased","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"x","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"y","type":"uint256"},{"indexed":false,"internalType":"string","name":"newColor","type":"string"}],"name":"PixelUpdated","type":"event"},{"inputs":[],"name":"MAX_STRING_LENGTH","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_RESALE_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PIXEL_COST","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PIXEL_SIZE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TRANSACTION_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"}],"name":"buyListedPixel","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"},{"internalType":"string","name":"color","type":"string"}],"name":"buyPixel","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"},{"internalType":"uint256","name":"price","type":"uint256"}],"name":"listPixelForSale","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"pixels","outputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"},{"internalType":"string","name":"color","type":"string"},{"internalType":"address","name":"currentOwner","type":"address"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"string","name":"image","type":"string"},{"internalType":"string","name":"link","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"},{"internalType":"string","name":"newColor","type":"string"}],"name":"updatePixelColor","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"},{"internalType":"string","name":"newImage","type":"string"}],"name":"updatePixelImage","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"},{"internalType":"string","name":"newLink","type":"string"}],"name":"updatePixelLink","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const connectWalletButton = document.getElementById("connectWallet");
    const purchaseButton = document.getElementById("purchasePixels");
    const selectedPixelsDisplay = document.getElementById("selectedPixels");

    let web3;
    let pixelStoreContract;
    let selectedPixels = [];
    let pixelSize = 20;

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      drawGrid();
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function drawGrid() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = "#ddd";

      for (let x = 0; x < canvas.width; x += pixelSize) {
        for (let y = 0; y < canvas.height; y += pixelSize) {
          ctx.strokeRect(x, y, pixelSize, pixelSize);
        }
      }

      selectedPixels.forEach(pixel => {
        const [x, y] = pixel.split(",").map(Number);
        ctx.fillStyle = "rgba(0, 128, 255, 0.5)";
        ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
      });
    }

    canvas.addEventListener("click", event => {
      const x = Math.floor(event.clientX / pixelSize);
      const y = Math.floor(event.clientY / pixelSize);
      const key = `${x},${y}`;

      if (!selectedPixels.includes(key)) {
        selectedPixels.push(key);
      } else {
        selectedPixels = selectedPixels.filter(p => p !== key);
      }

      selectedPixelsDisplay.textContent = selectedPixels.length;
      drawGrid();
    });

    async function connectWallet() {
      if (typeof window.ethereum === "undefined") {
        alert("Please install MetaMask!");
        return;
      }

      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        web3 = new Web3(window.ethereum);
        pixelStoreContract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
        alert("Wallet connected!");
        purchaseButton.disabled = false;
      } catch (error) {
        console.error("Error connecting wallet:", error);
      }
    }

    async function purchasePixels() {
      if (!web3 || !pixelStoreContract) {
        alert("Please connect your wallet first.");
        return;
      }

      const accounts = await web3.eth.getAccounts();
      const account = accounts[0];
      const pricePerPixel = await pixelStoreContract.methods.PIXEL_COST().call();
      const totalCost = web3.utils.toBN(pricePerPixel).mul(web3.utils.toBN(selectedPixels.length));

      try {
        await pixelStoreContract.methods.buyPixels(selectedPixels).send({
          from: account,
          value: totalCost
        });
        alert("Pixels purchased successfully!");
        selectedPixels = [];
        selectedPixelsDisplay.textContent = selectedPixels.length;
        drawGrid();
      } catch (error) {
        console.error("Error purchasing pixels:", error);
      }
    }

    connectWalletButton.addEventListener("click", connectWallet);
    purchaseButton.addEventListener("click", purchasePixels);
  </script>
</body>
</html>

